<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸‹è½½</title>
    <link rel="icon" href="{{ url_for('static', filename='icon.ico') }}" type="image/x-icon">
    <style>
body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 10px;
}

.containerAll {
    background: #1a1a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    min-width: 100%;
    margin: 0;
    position:fixed;
    z-index: 1000;
}

.container {
    position: relative;
    width: 200px;
    height: 200px;
}

.quantum-loader {
    position: absolute;
    width: 100%;
    height: 100%;
    animation: float 3s ease-in-out infinite;
}

.core {
    position: absolute;
    width: 40px;
    height: 40px;
    background: linear-gradient(45deg, #00ffff, #ff00ff);
    border-radius: 50%;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    filter: blur(5px);
    animation: pulse 2s ease-in-out infinite;
}

.particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #00ffff;
    border-radius: 50%;
    filter: blur(2px);
    animation: rotate 4s linear infinite;
}

.particle:nth-child(2) {
    background: #ff00ff;
    animation-delay: -1s;
}

.particle:nth-child(3) {
    background: #00ff00;
    animation-delay: -2s;
}

.loading-text {
    position: absolute;
    bottom: -40px;
    width: 100%;
    text-align: center;
    color: #fff;
    font-family: Arial, sans-serif;
    letter-spacing: 2px;
    max-lines: 2;
}

.loading-text::after {
    content: '...';
    display: inline-block;
    animation: dots 1.5s steps(3, end) infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

@keyframes pulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.2); }
}

@keyframes rotate {
    0% {
        transform: rotate(0deg) translateX(60px) scale(1);
        opacity: 0.8;
    }
    100% {
        transform: rotate(360deg) translateX(60px) scale(0.5);
        opacity: 0.2;
    }
}

@keyframes dots {
    0% { content: ''; }
    33% { content: '.'; }
    66% { content: '..'; }
    100% { content: '...'; }
}


.file-browser {
    margin: 0 auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

h1 {
    font-size: 24px;
    margin-bottom: 20px;
    color: #333;
}

details {
    margin-bottom: 5px;
    min-width: 300px;
}

summary {
    font-weight: bold;
    cursor: pointer;
    padding: 10px;
    background: linear-gradient(to right,rgb(161, 193, 205),#ffffff);
    border-radius: 4px;
    border: 1px solid #ddd;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease-in-out;
    height: 30px;
    text-overflow: ellipsis;
    white-space: nowrap;
}
summary:hover {
    animation: key 0.5s ease-in-out;
    height: 50px;
}
@keyframes key {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

/* summary:hover {
    background-color: #f1f1f1;
} */

.file-item {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    margin-left: 20px;
    border-left: 2px solid #ddd;
    background-color: #e8e8e8;
    transition: all 0.3s ease-in-out;
    height: 30px;
}

.file-item:hover {
    background-color: #f9f9f9 !important;
    height: 50px;
}

.file-name {
    flex-grow: 1;
    margin-right: 10px;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
}

.download-button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    min-width: 48px;
}
.close-button {
    color: black;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
    display: none;
}

.close-button:hover {
    background-color: #f9f9f9;
}
.download-button:hover {
    background-color: #0056b3;
}

/* åŠ¨æ€ç¼©è¿› */
details details {
    margin-left: 20px;
}

details details details {
    margin-left: 20px;
}

details details details details {
    margin-left: 20px;
}


:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --success-color: #27ae60;
    --background: #f8f9fa;
    --text-color: #2c3e50;
}

.file-directory {
    width: 320px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    font-family: 'Segoe UI', system-ui, sans-serif;
    overflow: hidden;
    transition: all 0.2s ease-in-out;
    margin-left: -520px;
    display: none;
    opacity: 0;
}

.file-directory:hover {
    transform: translateY(-2px);
}

.directory-header {
    padding: 20px;
    background: var(--primary-color);
    color: white;
}

.folder-icon {
    width: 48px;
    height: 48px;
    margin-bottom: 12px;
}

.directory-name {
    font-size: 1.4rem;
    font-weight: 600;
    margin: 8px 0;
}

.directory-path {
    font-size: 0.9rem;
    opacity: 0.8;
    word-break: break-all;
}

.metadata {
    display: flex;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--background);
    border-bottom: 1px solid #eee;
}

.meta-item {
    text-align: center;
}

.meta-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 4px;
}

.meta-value {
    font-weight: 600;
    color: var(--text-color);
}

.download-section {
    padding: 20px;
    text-align: center;
}

.download-btn {
    background: var(--success-color);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.download-btn:hover {
    background: #219a52;
    transform: scale(1.05);
}

.download-btn:active {
    transform: scale(0.98);
}

.loading .download-btn {
    background: #95a5a6 !important;
    cursor: progress;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.spinner {
    animation: spin 1s linear infinite;
    display: inline-block;
}

.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* å¼¹çª—å®¹å™¨ */
.dialog {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    min-width: 320px;
    transform: scale(0.9);
    opacity: 0;
    transition: all 0.3s ease;
}

/* å¼¹çª—æ¿€æ´»çŠ¶æ€ */
.dialog.active {
    transform: scale(1);
    opacity: 1;
}

/* å¼¹çª—æ ‡é¢˜ */
.dialog-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #333;
}

/* å¼¹çª—å†…å®¹ */
.dialog-content {
    color: #666;
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

/* æŒ‰é’®å®¹å™¨ */
.dialog-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

/* é€šç”¨æŒ‰é’®æ ·å¼ */
.dialog-button {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

/* ç¡®è®¤æŒ‰é’® */
.confirm-btn {
    background: #007bff;
    color: white;
}

.confirm-btn:hover {
    background: #0056b3;
}

/* å–æ¶ˆæŒ‰é’® */
.cancel-btn {
    background: #f0f0f0;
    color: #666;
}

.cancel-btn:hover {
    background: #e0e0e0;
}

/* å±é™©çŠ¶æ€ */
.dialog.warning .confirm-btn {
    background: #dc3545;
}

.dialog.warning .confirm-btn:hover {
    background: #bb2d3b;
}
.maxh{
    max-height: 100px !important;
}
.maxhopen{
    transition: all 1s ease-in-out;
}
details{
    overflow-y: hidden;
    /* overflow-x: auto; */
}

.dark-mode {
    background-color: #333 !important;
    color: #fff;
}
.toggle-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    transition: background-color 0.3s ease;
}

.toggle-button:hover {
    background-color: #0056b3;
}

/* ä¾§è¾¹å¯¼èˆªæ  */
.side-nav {
    position: fixed;
    top: 0;
    left: -300px; /* é»˜è®¤éšè— */
    width: 300px;
    height: 100vh;
    background-color: #fff;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    transition: left 0.3s ease;
    z-index: 999;
}

.side-nav.active {
    left: 0; /* å±•å¼€æ—¶æ˜¾ç¤º */
}

/* å¯¼èˆªéƒ¨åˆ† */
.nav-section {
    padding: 20px;
    border-bottom: 1px solid #ddd;
}

.nav-item {
    padding: 10px 0;
    font-size: 16px;
    color: #333;
    cursor: pointer;
    transition: color 0.3s ease;
}

.nav-item:hover {
    color: #007bff !important;
}

/* å¯æŠ˜å éƒ¨åˆ† */
.collapsible .nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.collapsible .nav-content {
    display: none; /* é»˜è®¤æŠ˜å  */
    padding-left: 20px;
}

.collapsible.active .nav-content {
    display: block; /* å±•å¼€æ—¶æ˜¾ç¤º */
}

.collapse-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.collapsible.active .collapse-icon {
    transform: rotate(180deg);
}

/* æ·±è‰²æ¨¡å¼åˆ‡æ¢ */
.dark-mode-switch {
    margin-left: 10px;
}
a{
    text-decoration: none;
}

.fontcolor{
    color: #ffffff;
}
.fontcolor2{
    color: #000;
}
.fontcolor3{
    color: #007bff !important;
}
.fontcolor4{
    transition: all 0.3s ease-in-out;
}
.fontcolor4:hover{
    color: #007bff !important;
}

/* å­—ä½“æ ·å¼é€‰æ‹© */
.font-style-select {
    margin-left: 10px;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #fff;
    color: #333;
    cursor: pointer;
}
    </style>
</head>
<body>
    <button class="toggle-button" id="toggle-button">â˜°</button>

    <!-- ä¾§è¾¹å¯¼èˆªæ  -->
    <div class="side-nav" id="side-nav">
        <!-- ä¸å¯æŠ˜å éƒ¨åˆ† -->
        <div class="nav-section">
            <div class="nav-item"><a href="/files" class="fontcolor3">ä¸‹è½½æ–‡ä»¶</a></div>
            <div class="nav-item"><a href="/upload" class="fontcolor4">ä¸Šä¼ </a></div>
            <div class="nav-item"><a onclick="DataUp()" class="fontcolor4">è¯·æ±‚æœåŠ¡ç«¯æ›´æ–°</a></div>
        </div>
    
        <!-- å¯æŠ˜å éƒ¨åˆ† -->
        <div class="nav-section collapsible">
            <div class="nav-header">
                <a>è®¾ç½®</a>
                <span class="collapse-icon">â–¼</span>
            </div>
            <div class="nav-content">
                <div class="nav-item">
                    <label for="dark-mode"><a>æ·±è‰²æ¨¡å¼</a></label>
                    <input type="checkbox" id="dark-mode" class="dark-mode-switch">
                </div>
                <div class="nav-item">
                    <label for="font-style"><a>å­—ä½“æ ·å¼</a></label>
                    <select id="font-style" class="font-style-select">
                        <option value="Arial">Arial</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Georgia">Georgia</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-item" id="outbar"><a>å…³é—­</a></div>
        </div>
    </div>
    <div class="containerAll" id="long-loading">
        <div class="container">
            <div class="quantum-loader">
                <div class="core"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            <div class="loading-text" id="loading-text">æœåŠ¡å™¨æ­£åœ¨åŠ è½½</div>
        </div>
    </div>
    <div class="file-browser" id="file-browser">
        <h1>æ–‡ä»¶ä¸‹è½½</h1>
        <div id="fileList"></div>
    </div>



    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io('http://127.0.0.1:5000');
    
        socket.on('connect', () => {
            console.log('Connected to server');  // æ·»åŠ æ—¥å¿—ä»¥ç¡®è®¤è¿æ¥
        });
    
        socket.on('update', (data) => {
            console.log('å®æ—¶æ—¶é—´:', data.time);
        });
    
        socket.on('server_push', (msg) => {
            console.log('ç³»ç»Ÿæ¶ˆæ¯:', msg.status);
        });
    </script> -->
    <script>

var coincide = false;

function getFileTypeIcon(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
        return 'ğŸ–¼ï¸'; // å›¾ç‰‡æ–‡ä»¶å›¾æ ‡
    } else if (['txt', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext)) {
        return 'ğŸ“„'; // æ–‡æœ¬æ–‡ä»¶å›¾æ ‡
    } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
        return 'ğŸµ'; // éŸ³é¢‘æ–‡ä»¶å›¾æ ‡
    } else if (['mp4', 'avi', 'mov'].includes(ext)) {
        return 'ğŸ¥'; // è§†é¢‘æ–‡ä»¶å›¾æ ‡
    } else if (['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz'].includes(ext)) {
        return 'ğŸ“¦'; // å‹ç¼©æ–‡ä»¶å›¾æ ‡
    } else if (['exe', 'dll', 'bat'].includes(ext)) {
        return 'ğŸ—¿'; // å¯æ‰§è¡Œæ–‡ä»¶å›¾æ ‡
    } else if (['md', 'rst', 'txt', 'log'].includes(ext)) {
        return 'ğŸ“ƒ'; // æ–‡æ¡£æ–‡ä»¶å›¾æ ‡
    } else if (ext == 'py'){
        return 'ğŸ'; // Pythonæ–‡ä»¶å›¾æ ‡
    } else if (ext == 'css'){
        return 'ğŸ¨'; // CSSæ–‡ä»¶å›¾æ ‡
    } else if (ext == 'html'){
        return 'ğŸŒ'; // HTMLæ–‡ä»¶å›¾æ ‡
    } else if (ext == 'js'){
        return 'ğŸ¤–'; // JavaScriptæ–‡ä»¶å›¾æ ‡
    } else if (ext == 'json'){
        return 'ğŸ”§'; // JSONæ–‡ä»¶å›¾æ ‡
    } else if (ext == 'xml'){
        return 'ğŸŒˆ'; // XMLæ–‡ä»¶å›¾æ ‡
    } else if (['yaml', 'yml'].includes(ext)){
        return 'ğŸˆ'; // YAMLæ–‡ä»¶å›¾æ ‡
    } else if (ext == 'go'){
        return 'ğŸ¹'; // Goæ–‡ä»¶å›¾æ ‡
    } else if (ext == 'php'){
        return 'ğŸ˜'; // PHPæ–‡ä»¶å›¾æ ‡
    } else {
        return 'â“'; // æœªçŸ¥æ–‡ä»¶å›¾æ ‡
    }
}   


function createDialog(title, content, isWarning = false) {
    const overlay = document.createElement('div')
    overlay.className = 'dialog-overlay'
    
    const dialog = document.createElement('div')
    dialog.className = `dialog ${isWarning ? 'warning' : ''}`
    
    dialog.innerHTML = `
      <div class="dialog-title">${title}</div>
      <div class="dialog-content">${content}</div>
      <div class="dialog-actions">
        <button class="dialog-button cancel-btn">å–æ¶ˆ</button>
        <button class="dialog-button confirm-btn">ç¡®å®š</button>
      </div>
    `

    overlay.appendChild(dialog)
    document.body.appendChild(overlay)
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
      overlay.style.display = 'flex'
      setTimeout(() => dialog.classList.add('active'), 10)
    }, 10)

    return new Promise((resolve) => {
      dialog.querySelector('.confirm-btn').addEventListener('click', () => {
        closeDialog(true)
      })
      
      dialog.querySelector('.cancel-btn').addEventListener('click', () => {
        closeDialog(false)
      })

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeDialog(false)
      })

      const closeDialog = (result) => {
        dialog.classList.remove('active')
        setTimeout(() => {
          overlay.remove()
          resolve(result)
        }, 300)
      }
    })
  }

  async function confirmOpenFile() {
    const firstConfirm = await createDialog(
      'æ“ä½œç¡®è®¤',
      'å½“å‰ç›®å½•æ–‡ä»¶æ•°é‡è¶…è¿‡60ï¼Œä½ ç¡®å®šè¦å…¨éƒ¨æ‰“å¼€å—?'
    )
    
    if (!firstConfirm) return false
    
    const secondConfirm = await createDialog(
      'é£é™©è­¦å‘Š',
      'å»ºè®®æ‰‹åŠ¨æ‰“å¼€,å¦‚æœå¼ºè¡Œå…¨éƒ¨å¼€å¯,æ¸²æŸ“å¯èƒ½ä¼šå¯¼è‡´çª—å£å¡é¡¿å´©æºƒï¼Œä½ è¿˜è¦ç»§ç»­å—ï¼Ÿ',
      true
    )
    
    return secondConfirm
  }



  function countFilesAndFolders(data) {
  let fileCount = 0; // æ–‡ä»¶æ€»æ•°
  let folderCount = 0; // ç›®å½•æ€»æ•°

  function count(data) {
    if (Array.isArray(data)) {
      // éå†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ 
      data.forEach(item => {
        if (item.type === 'file') {
          // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè¯´æ˜æ˜¯æ–‡ä»¶
          fileCount++;
        } else if (item.type === 'folder') {
          // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè¯´æ˜æ˜¯ç›®å½•
          folderCount++;
          // é€’å½’éå†ç›®å½•ä¸­çš„ items
          if (item.items && Array.isArray(item.items)) {
            count(item.items);
          }
        }
      });
    }
  }

  count(data); // å¼€å§‹ç»Ÿè®¡
  return { fileCount, folderCount }; // è¿”å›æ–‡ä»¶å’Œç›®å½•çš„æ•°é‡
}


function showTempAlert(message) {
  // 1. åˆ›å»ºå¼¹çª—å…ƒç´ 
  const alertBox = document.createElement('div');
  alertBox.className = 'alert-box';
  const margintop = 70 * document.getElementsByClassName('alert-box').length;
  // 2. è®¾ç½®åŸºç¡€æ ·å¼ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
  Object.assign(alertBox.style, {
    position: 'fixed',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    padding: '20px 30px',
    backgroundColor: 'rgba(0, 0, 0, 0.85)',
    color: 'white',
    borderRadius: '8px',
    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
    zIndex: '1000',
    fontSize: '16px',
    transition: 'opacity 0.3s ease',
    marginTop: `${margintop}px`,
    opacity: '0' // åˆå§‹é€æ˜ç”¨äºæ¸æ˜¾åŠ¨ç”»
  });

  // 3. æ·»åŠ æ–‡æœ¬å†…å®¹
  alertBox.textContent = message;

  // 4. æ’å…¥åˆ°é¡µé¢
  document.body.appendChild(alertBox);

  // 5. è§¦å‘æ¸æ˜¾åŠ¨ç”»
  setTimeout(() => {
    alertBox.style.opacity = '1';
  }, 10);

  // 6. 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
  setTimeout(() => {
    alertBox.style.opacity = '0';
    // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
    setTimeout(() => {
      document.body.removeChild(alertBox);
    }, 300);
  }, 2000);
}

function convertSeconds(totalSeconds) {
    console.log(totalSeconds)
  const minutes = Math.floor(totalSeconds / 60);  // è®¡ç®—å®Œæ•´åˆ†é’Ÿæ•°
  const seconds = totalSeconds % 60;              // è®¡ç®—å‰©ä½™ç§’æ•°
  return `${parseInt(minutes)}åˆ†${parseInt(seconds)}ç§’`;
}

function handleDownload(fullPath,size,fileCount){
    // è·å–æŒ‰é’®å…ƒç´ 
    let button = event.target.closest('.download-btn');
    
    // è·å–çˆ¶å®¹å™¨
    let section = event.currentTarget.closest('.download-section');
    let metadata = button.closest('.file-directory');
    let settimesstart = metadata.querySelector('.settime');
    settimesstart.textContent = "";
    let js = 0
    let timestart
    timestart = setInterval(() => {
        js++;
        settimesstart.textContent = `å·²ç­‰å¾…${js} S/${parseInt(size/24)} S`
    }, 1000);
                        //   .querySelector('.download-section');
        // console.log(metadata)
        let originalHTML = button.innerHTML
        button.innerHTML = `
                    <svg class="spinner" width="20" height="20" viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5"/>
                    </svg>
                    æ‰“åŒ…ä¸­...
                `
    button.disabled = true
    metadata.classList.add('loading')
    const formattedTime = convertSeconds(size / 6 + fileCount / 75);
    showTempAlert(`æ­£åœ¨æ‹‰å–æ–‡ä»¶ä¸­,å¤§çº¦éœ€è¦${formattedTime}è¯·ç¨å...`)
    // window.location.href = `/downloadzip/${fullPath}`;
    var xhr = new XMLHttpRequest();
xhr.open('GET', `/downloadzip/${fullPath}`, true);

// è®¾ç½® responseType ä¸º 'blob'ï¼Œä»¥ä¾¿å¤„ç†æ–‡ä»¶
xhr.responseType = 'blob';

xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) { // è¯·æ±‚å®Œæˆ
        clearInterval(timestart); // æ¸…é™¤è®¡æ—¶å™¨
        button.innerHTML = originalHTML; // æ¢å¤æŒ‰é’®å†…å®¹
        button.disabled = false; // å¯ç”¨æŒ‰é’®
        metadata.classList.remove('loading'); // ç§»é™¤åŠ è½½çŠ¶æ€

        if (xhr.status >= 200 && xhr.status < 300) { // è¯·æ±‚æˆåŠŸ
            var contentType = xhr.getResponseHeader('Content-Type');

            if (contentType && contentType.includes('application/json')) {
                // å¦‚æœè¿”å›çš„æ˜¯ JSONï¼Œä½¿ç”¨ FileReader è¯»å– Blob æ•°æ®
                var blob = xhr.response;
                var reader = new FileReader();

                reader.onload = function () {
                    try {
                        var response = JSON.parse(reader.result); // è§£æ JSON
                        console.log('æœåŠ¡å™¨è¿”å› JSON:', response);
                        button.style.background = 'red'; // è®¾ç½®æŒ‰é’®èƒŒæ™¯ä¸ºçº¢è‰²
                        showTempAlert(response.code || 'æœªçŸ¥é”™è¯¯'); // æ˜¾ç¤ºé”™è¯¯æç¤º
                    } catch (e) {
                        console.error('è§£æ JSON å¤±è´¥:', e);
                        button.style.background = 'red'; // è®¾ç½®æŒ‰é’®èƒŒæ™¯ä¸ºçº¢è‰²
                        showTempAlert('è§£æå“åº”å¤±è´¥ï¼');
                    }
                };

                reader.onerror = function () {
                    console.error('è¯»å– Blob å¤±è´¥');
                    button.style.background = 'red'; // è®¾ç½®æŒ‰é’®èƒŒæ™¯ä¸ºçº¢è‰²
                    showTempAlert('è¯»å–å“åº”å¤±è´¥ï¼');
                };

                reader.readAsText(blob); // å°† Blob è½¬æ¢ä¸ºæ–‡æœ¬
            } else if (contentType && contentType.includes('application/zip')) {
                // å¦‚æœè¿”å›çš„æ˜¯æ–‡ä»¶
                console.log('æ–‡ä»¶è·å–æˆåŠŸ');
                button.style.background = 'rgb(38, 171, 94)'; // è®¾ç½®æŒ‰é’®èƒŒæ™¯ä¸ºç»¿è‰²
                showTempAlert('æ–‡ä»¶æ‹‰å–æˆåŠŸï¼'); // æ˜¾ç¤ºæˆåŠŸæç¤º

                var blob = xhr.response; // è·å– Blob å¯¹è±¡
                var contentDisposition = xhr.getResponseHeader('Content-Disposition');
                var filename = 'download.zip'; // é»˜è®¤æ–‡ä»¶å

                // ä» Content-Disposition ä¸­æå–æ–‡ä»¶å
                if (contentDisposition) {
                    // å°è¯•ä» filename* æå– UTF-8 ç¼–ç çš„æ–‡ä»¶å
                    var filenameStarRegex = /filename\*=(?:UTF-8'')?([^;]+)/i;
                    var filenameStarMatch = filenameStarRegex.exec(contentDisposition);

                    if (filenameStarMatch && filenameStarMatch[1]) {
                        // è§£ç  filename* çš„å€¼
                        filename = decodeURIComponent(filenameStarMatch[1]);
                    } else {
                        // å¦‚æœ filename* ä¸å­˜åœ¨ï¼Œå°è¯•ä» filename æå–æ–‡ä»¶å
                        var filenameRegex = /filename=(?:["']?)([^;"']+)(?:["']?)/i;
                        var filenameMatch = filenameRegex.exec(contentDisposition);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1];
                        }
                    }
                }

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = filename; // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶å
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url); // é‡Šæ”¾ URL å¯¹è±¡
            } else {
                // æœªçŸ¥çš„å“åº”ç±»å‹
                console.log('æœªçŸ¥çš„å“åº”ç±»å‹:', contentType);
                button.style.background = 'red'; // è®¾ç½®æŒ‰é’®èƒŒæ™¯ä¸ºçº¢è‰²
                showTempAlert('æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
            }
        } else {
            // æ–‡ä»¶è·å–å¤±è´¥
            console.log('æ–‡ä»¶è·å–å¤±è´¥');
            button.style.background = 'red'; // è®¾ç½®æŒ‰é’®èƒŒæ™¯ä¸ºçº¢è‰²
            showTempAlert('æ–‡ä»¶æ‹‰å–å¤±è´¥ï¼'); // æ˜¾ç¤ºå¤±è´¥æç¤º
        }
    }
};

xhr.send();
    
}

function closeAllDetails(element,isopenclose) {
    const detailsElements = element.querySelectorAll('details');
    detailsElements.forEach(details => {
        details.open = false; // å…³é—­å½“å‰ç›®å½•
        closeAllDetails(details); // é€’å½’å…³é—­å­ç›®å½•
    });
    const cent = element.querySelectorAll('.file-directory')
    // cent.forEach(cents => {
    //     cents.style.display = 'none';
    //     cent.opacity = '0';
    // })
    // console.log(typeof isopenclose)
    
}
function openAllDetails(element) {
    const detailsElements = element.querySelectorAll('details');
    detailsElements.forEach(details => {
        details.open = true; // æ‰“å¼€å½“å‰ç›®å½•
        openAllDetails(details); // é€’å½’æ‰“å¼€å­ç›®å½•
    });
}

function openDetails(element,isopen) {
    if (isopen){
        element.style.display = 'inline-block'
        element.style.marginLeft = '0px';
        element.style.opacity = '1';
        
    }else{
        element.style.marginLeft = '-520px';
        element.style.opacity = '0';
        setTimeout(()=>{element.style.display = 'none'}, 200);
    }
}

// æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒå¤šå±‚åµŒå¥—ï¼‰
function renderFileList(items, container, currentPath = "") {
    items.forEach(item => {
        if (item.type === 'file') { // å¦‚æœæ˜¯æ–‡ä»¶
            let itemName = item
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';

            const fileName = document.createElement('p');

            fileName.className = 'file-name fontcolor2';
            fileName.textContent = `${getFileTypeIcon(itemName.file)}${itemName.file}`;
            fileName.title = itemName.file;

            const downloadButton = document.createElement('button');
            downloadButton.className = 'download-button';
            downloadButton.textContent = 'ä¸‹è½½';

            // æ‹¼æ¥å®Œæ•´è·¯å¾„
            const fullPath = currentPath ? `${currentPath}/${itemName.file}` : itemName.file;

            downloadButton.addEventListener('click', () => {
                downloadFile(fullPath); // ä¼ é€’å®Œæ•´è·¯å¾„
            });

            fileItem.appendChild(fileName);
            fileItem.appendChild(downloadButton);
            if (container != document.getElementById('fileList')){
                fileItem.style.background = '#b3b1b1';
                container.appendChild(fileItem);
            }else{
                fileItem.style.marginLeft = '0';
                container.appendChild(fileItem);
            }
        } else if (item === 'dir') {
            let itemName = item
            let {fileCount, folderCount } = countFilesAndFolders(itemName.items);
             // å¦‚æœæ˜¯æ–‡ä»¶å¤¹
            let isopen = true;
            const details = document.createElement('details');
            details.style.maxHeight = `${folderCount  * 55 + fileCount * 55 + 200}px`;
            details.className = 'maxh';
            const summary = document.createElement('summary');
            summary.innerHTML = `<a style="text-overflow:ellipsis,white-space:nowrap,overflow:hidden;width:0%">ğŸ“  ${itemName.folder} (${fileCount})</a>`;
            
            const closeButton = document.createElement('button');
            closeButton.className = 'close-button';
            closeButton.textContent = 'å…³é—­ç›®å½•';
            closeButton.addEventListener('click', (event) => {
                event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                details.open = false; // å…³é—­å½“å‰ç›®å½•
                closeAllDetails(details,()=>{isopen = false;}); // é€’å½’å…³é—­å­ç›®å½•
            });

            const closeButton2 = document.createElement('button');
            closeButton2.className = 'close-button';
            closeButton2.textContent = 'å…¨éƒ¨å±•å¼€';
            closeButton2.style.display = 'inline-block';
            closeButton2.style.position = 'static';
            closeButton2.addEventListener('click', (event) => {
                function startopen(){
                    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    details.open = true; // æ‰“å¼€å½“å‰ç›®å½•
                    openAllDetails(details); // é€’å½’å…³é—­å­ç›®å½•
                }
                if (fileCount > 60){
                    confirmOpenFile().then(result => {
                        if (result) {
                            startopen();
                        }
                    });
                }else {
                    startopen();
                }
                
            });

            
            
            const closeButton3 = document.createElement('button');
            closeButton3.className = 'close-button';
            closeButton3.textContent = 'è¯¦ç»†ä¿¡æ¯';
            closeButton3.style.display = 'inline-block';
            closeButton3.style.display = 'none';
            closeButton3.addEventListener('click', (event) => {
                openDetails(dirhome,isopen)
                isopen = !isopen;
                closeButton3.innerText = isopen ? 'è¯¦ç»†ä¿¡æ¯' : 'æ”¶èµ·è¯¦ç»†ä¿¡æ¯';
            });
            const fullPath = currentPath ? `${currentPath}/${itemName.folder}` : itemName.folder;
            // console.log(fullPath)
            let positionhome = document.createElement('div');
            positionhome.style.position = 'absolute';
            let dirseek = document.createElement('div');
            dirseek.style.position = 'relative';
            let dirhome = document.createElement('div');
            dirhome.className = 'file-directory';
            dirhome.innerHTML = `<div class="directory-header">
                    <svg class="folder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                    <div class="directory-name">${itemName.folder}</div>
                    <div class="directory-path">${fullPath}</div>
                </div>
                
                <div class="metadata">
                    <div class="meta-item">
                        <div class="meta-label">æ–‡ä»¶æ•°é‡</div>
                        <div class="meta-value" id="file-count">${fileCount}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">æ€»å¤§å°</div>
                        <div class="meta-value" id="total-size">${itemName.size} MB</div>
                    </div>
                </div>

                <div class="download-section">
                    <button class="download-btn" onclick="handleDownload('${fullPath}',${itemName.size},${fileCount})">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        æ‰“åŒ…ä¸‹è½½
                    </button>
                    <div class="settime"></div>
            </div>`

            

            dirseek.appendChild(dirhome);
            positionhome.appendChild(dirseek);
            details.appendChild(positionhome);
            let dirhome2 = document.createElement('div');
            dirhome2.appendChild(closeButton3);
            dirhome2.appendChild(closeButton);
            dirhome2.appendChild(closeButton2);
            summary.appendChild(dirhome2);
            details.appendChild(summary);

            // æ›´æ–°å½“å‰è·¯å¾„
            const newPath = currentPath ? `${currentPath}/${itemName.folder}` : itemName.folder;

            // ç›‘å¬å±•å¼€/æŠ˜å äº‹ä»¶
            details.addEventListener('toggle', (event) => {
                if (details.open) {
                    // console.log(`å±•å¼€æ–‡ä»¶å¤¹: ${item.folder}`);
                    summary.style.background = 'linear-gradient(to right,#f5aeae,#ffffff)';
                    details.classList.add('maxhopen');
                    details.classList.remove('maxh');
                    closeButton.style.display = 'inline-block';
                    closeButton2.style.display = 'none';
                    closeButton3.style.display = 'inline-block';
                } else {
                    // console.log(`æŠ˜å æ–‡ä»¶å¤¹: ${item.folder}`);
                    summary.style.background = 'linear-gradient(to right,#a1c1cd,#ffffff)';
                    details.classList.remove('maxhopen');
                    details.classList.add('maxh');
                    closeButton.style.display = 'none';
                    closeButton2.style.display = 'inline-block';
                    closeButton3.style.display = 'none';
                    }
            });
            details.addEventListener('mouseenter',{

            })
            // details.addEventListener('mouseenter', (event) => {
            //     dirhome.style.marginLeft = '-320px';
            //     dirhome.style.marginTop = '-70px'
            // })
            // details.addEventListener('mouseleave', (event) => {
            //     dirhome.style.marginLeft = '-520px';
            //     dirhome.style.marginTop = '0px'
            // })

            // é€’å½’æ¸²æŸ“å­é¡¹ï¼Œä¼ é€’æ–°çš„è·¯å¾„
            renderFileList(itemName.items, details, newPath);
            container.appendChild(details);
        }
    });
}

function removeTempAlert() {
    const element = document.getElementById('long-loading');
        if (element) { // å…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
        if (typeof element.remove === 'function') {
            // ç°ä»£æµè§ˆå™¨æ¨èæ–¹å¼
            element.remove();
        } else {
            // ä¼ ç»Ÿæ–¹å¼
            element.parentNode.removeChild(element);
        }
    }
}

// æ¨¡æ‹Ÿæ–‡ä»¶ä¸‹è½½
function downloadFile(filename) {
    window.location.href = `/get_files/${filename}`;
}


        handleFiles();
        function handleFiles() {
            let setsys
            setsys = setTimeout(()=>{
                document.getElementById('loading-text').textContent = 'æœåŠ¡å™¨é¦–æ¬¡å¯åŠ¨ä¸­åŠ è½½æ•°é‡è¾ƒå¤š,è¯·è€å¿ƒç­‰å¾…ä¸€ä¸‹'; // å¯ç”¨ä¸Šä¼ æŒ‰é’®
            },7000)
            fetch('/files', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                // console.log('Upload success:', data);
                const filedata = data.code;
                const fileListContainer = document.getElementById('fileList');
                removeTempAlert();
                showTempAlert('æ–‡ä»¶åˆ—è¡¨åŠ è½½æˆåŠŸï¼'); // æ˜¾ç¤ºæˆåŠŸæç¤º
                clearTimeout(setsys);
                renderFileList(filedata.files,fileListContainer);
            })
            .catch(error => {
                showTempAlert(`æœªçŸ¥é”™è¯¯:${error},å¯èƒ½æ˜¯ç”±äºæœåŠ¡å™¨å·²ç»ä¸‹ç½‘`);
                document.getElementById('loading-text').textContent = `æœªçŸ¥é”™è¯¯:${error}\nå¯èƒ½æ˜¯ç”±äºæœåŠ¡å™¨å·²ç»ä¸‹ç½‘`; // å¯ç”¨ä¸Šä¼ æŒ‰é’®
                console.error('Upload error:', error);
            });
        }
        // æ¨¡æ‹ŸæœåŠ¡å™¨è¿”å›çš„ JSON æ•°æ®

    </script>

<script>
var ifdataup = false;

function DataUp() {
    if (ifdataup == false) {
        showTempAlert('æ­£åœ¨å‘æœåŠ¡å™¨å‘èµ·æ›´æ–°è¯·æ±‚ä¸­,è¯·ç¨å...')
    }else{
        showTempAlert('å·²ç»å‘æœåŠ¡å™¨å‘èµ·æ›´æ–°è¯·æ±‚,è¯·å‹¿é‡å¤ç‚¹å‡»')
        return;
    }
    fetch('/dataup', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        let datacode = data.code;
        showTempAlert(datacode); // æ˜¾ç¤ºæˆåŠŸæç¤º
        if (data.msg == 1){
            ifdataup = true;
            setTimeout(()=>{location.reload()},2000)
        }
    })
    .catch(error => {
        ifdataup = true;
        showTempAlert(`æœªçŸ¥é”™è¯¯:${error},å¯èƒ½æ˜¯ç”±äºæœåŠ¡å™¨å·²ç»ä¸‹ç½‘`);
        console.error('Upload error:', error);
    });
}

    function darkedit(){
let darkModeSwitch = document.getElementById('dark-mode');
document.body.classList.toggle('dark-mode', darkModeSwitch.checked);
    // å‡è®¾ collapsibleSections å·²ç»æ˜¯æ‰€æœ‰éœ€è¦åˆ‡æ¢æš—æ¨¡å¼çš„å¯¼èˆªåŒºå—çš„é›†åˆ
    // å¦‚æœä¸æ˜¯ï¼Œåˆ™éœ€è¦é€šè¿‡æŸç§æ–¹å¼è·å–è¿™äº›å…ƒç´ ï¼Œä¾‹å¦‚ï¼š
    let collapsibleSections = document.querySelectorAll('a');
    let filebrowser = document.getElementById('file-browser');
    let h1 = document.getElementsByTagName('h1');
    let p = document.getElementsByTagName('p');
    // ä½†æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦å¤„ç†ä¸ºæ•°ç»„æˆ–ä½¿ç”¨ Array.from æ¥éå†
    
    // ä½¿ç”¨ forEach éå†æ¯ä¸ªå…ƒç´ å¹¶åˆ‡æ¢æš—æ¨¡å¼ç±»
    Array.from(collapsibleSections).forEach(section => {
        section.classList.toggle('dark-mode', darkModeSwitch.checked);
    });
    filebrowser.classList.toggle('dark-mode', darkModeSwitch.checked);
    Array.from(h1).forEach(section => {
        section.classList.toggle('fontcolor', darkModeSwitch.checked);
    });
    collapsibleSections = document.getElementsByClassName('nav-section');
    Array.from(collapsibleSections).forEach(section => {
        section.classList.toggle('dark-mode', darkModeSwitch.checked);
    });
    document.getElementById('side-nav').classList.toggle('dark-mode', darkModeSwitch.checked);
}

function bar() {
const outbar = document.getElementById('outbar');
const toggleButton = document.getElementById('toggle-button');
const sideNav = document.getElementById('side-nav');
const collapsibleSections = document.querySelectorAll('.collapsible');
const darkModeSwitch = document.getElementById('dark-mode');
const fontStyleSelect = document.getElementById('font-style');
let darkMode = readDarkCookie();

// åˆ‡æ¢ä¾§è¾¹å¯¼èˆªæ 
toggleButton.addEventListener('click', () => {
    sideNav.classList.toggle('active');
});

outbar.addEventListener('click', () => {
    sideNav.classList.toggle('active');
});

// åˆ‡æ¢å¯æŠ˜å éƒ¨åˆ†
collapsibleSections.forEach(section => {
    const header = section.querySelector('.nav-header');
    header.addEventListener('click', () => {
        section.classList.toggle('active');
    });
});

// åˆ‡æ¢æ·±è‰²æ¨¡å¼
darkModeSwitch.addEventListener('change', () => {
    darkedit()
    setDarkCookie(darkModeSwitch.checked)
});

// åˆ‡æ¢å­—ä½“æ ·å¼
fontStyleSelect.addEventListener('change', () => {
    document.body.style.fontFamily = fontStyleSelect.value;
});
console.log('dark mode is set to ' + darkMode)
if (darkMode == true) {
    darkModeSwitch.checked = true;
    console.log('dark mode is set')
    darkedit()
}else{
    darkModeSwitch.checked = false;
    console.log('dark mode not set')
    darkedit()
}
}

// è®¾ç½® Cookie
function setDarkCookie(value) {
    // å°†å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    const cookieValue = `dark=${value}`;

    // è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 10 å¹´å
    const expirationDate = new Date();
    expirationDate.setFullYear(expirationDate.getFullYear() + 10);

    // è®¾ç½® Cookie
    document.cookie = `${cookieValue}; expires=${expirationDate.toUTCString()}; path=/`;
    console.log(`Cookie set: ${cookieValue}`);
}

// è¯»å– Cookie
function readDarkCookie() {
    // è·å–æ‰€æœ‰ Cookie
    const cookies = document.cookie.split(';');

    // æŸ¥æ‰¾åä¸º dark çš„ Cookie
    for (const cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'dark') {
            console.log(`Dark Cookie value: ${value}`);
            return value === 'true';
        }
    }

    // å¦‚æœæœªæ‰¾åˆ° dark Cookie
    console.log('Dark Cookie not found');
    setDarkCookie(true);
}

bar();
</script>
</body>
</html>